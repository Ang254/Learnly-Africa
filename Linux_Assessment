#!/bin/bash

# Simple script to install Docker, enable it, and run WordPress + MySQL (Amazon Linux 2 / CentOS)

echo "Updating system..."
sudo yum update -y

echo "Installing Docker..."
sudo amazon-linux-extras install docker -y || sudo yum install -y docker

echo "Starting Docker..."
sudo systemctl start docker

echo "Enabling Docker to start on boot..."
sudo systemctl enable docker

# Create a Docker network for WordPress and MySQL
echo "Creating Docker network..."
sudo docker network create wordpress-net || echo "Network already exists."

# Set environment variables
MYSQL_ROOT_PASSWORD="rootpassword"
MYSQL_DATABASE="wordpress"
MYSQL_USER="wpuser"
MYSQL_PASSWORD="wppassword"

echo "Starting MySQL container..."
sudo docker run -d \
  --name wordpress-db \
  --network wordpress-net \
  -e MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD \
  -e MYSQL_DATABASE=$MYSQL_DATABASE \
  -e MYSQL_USER=$MYSQL_USER \
  -e MYSQL_PASSWORD=$MYSQL_PASSWORD \
  -v mysql_data:/var/lib/mysql \
  mysql:5.7

echo "Starting WordPress container..."
sudo docker run -d \
  --name wordpress-app \
  --network wordpress-net \
  -p 80:80 \
  -e WORDPRESS_DB_HOST=wordpress-db:3306 \
  -e WORDPRESS_DB_USER=$MYSQL_USER \
  -e WORDPRESS_DB_PASSWORD=$MYSQL_PASSWORD \
  -e WORDPRESS_DB_NAME=$MYSQL_DATABASE \
  -v wordpress_data:/var/www/html \
  wordpress:latest

# Get public IP address
IP=$(curl -s ifconfig.me)

echo "##################################"
echo "WordPress + MySQL setup complete!"
echo "Visit: http://$IP"
echo "##################################"
